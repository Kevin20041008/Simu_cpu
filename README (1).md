# PriorityInterruptCPU

ä¸€ä¸ªç”¨ **Python** å®ç°çš„ã€å¸¦**å¯å±è”½ä¼˜å…ˆçº§ä¸­æ–­**ä¸**ä¸­æ–­åµŒå¥—**èƒ½åŠ›çš„ 8 ä½æ•™å­¦ CPU æ¨¡æ‹Ÿå™¨ã€‚  
ç‰¹ç‚¹ï¼šç®€å•ã€å¯è¯»ã€çº¯æ ‡å‡†åº“ï¼Œæ— éœ€ä¾èµ–ï¼Œé€‚åˆå­¦ä¹ â€œæŒ‡ä»¤å‘¨æœŸ / æ ‡å¿—ä½ / æ ˆ / è°ƒç”¨è¿”å› / ä¸­æ–­ä¼˜å…ˆçº§ä¸åµŒå¥—â€ç­‰æ¦‚å¿µã€‚

> ä»£ç æ–‡ä»¶ï¼š`PriorityInterruptCPU` ç±»ï¼ˆå•æ–‡ä»¶ç¤ºä¾‹å« `__main__` æ¼”ç¤ºï¼‰  
> è¯­è¨€ï¼šPython 3.8+ï¼ˆæ¨è 3.10+ï¼‰

---

## ç›®å½•
- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ ¸å¿ƒè®¾è®¡](#æ ¸å¿ƒè®¾è®¡)
- [å†…å­˜ä¸å¯„å­˜å™¨](#å†…å­˜ä¸å¯„å­˜å™¨)
- [ä¸­æ–­ç³»ç»Ÿ](#ä¸­æ–­ç³»ç»Ÿ)
- [æŒ‡ä»¤é›†](#æŒ‡ä»¤é›†)
- [ç¤ºä¾‹ç¨‹åº](#ç¤ºä¾‹ç¨‹åº)
- [æ‰©å±•ä¸å¼€å‘](#æ‰©å±•ä¸å¼€å‘)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [Roadmap](#roadmap)
- [è®¸å¯è¯](#è®¸å¯è¯)

---

## åŠŸèƒ½ç‰¹æ€§

- 8 ä½å¯„å­˜å™¨ï¼š`A, B, C, D, PC, SP, FLAGS`  
- 256 å­—èŠ‚å†…å­˜ + 16 å­—èŠ‚æ ˆ
- **ä¼˜å…ˆçº§ä¸­æ–­é˜Ÿåˆ—**ï¼ˆ`PriorityQueue`ï¼‰ä¸**ä¸­æ–­å±è”½**ã€**ä¸­æ–­åµŒå¥—**
- ç®€åŒ–ç‰ˆ**ä¸­æ–­å‘é‡è¡¨**ï¼ˆ0x00â€“0x07ï¼‰ï¼Œå†…ç½® 4 ä¸ªä¸­æ–­æœåŠ¡ä¾‹ç¨‹ï¼ˆISRï¼‰
- ç®—æœ¯/é€»è¾‘/ç§»ä½/è·³è½¬/æ ˆ/æ•°æ®ä¼ è¾“/æ¯”è¾ƒ/è¾“å…¥/ä¸­æ–­ ç­‰æŒ‡ä»¤
- çº¯æ ‡å‡†åº“ï¼ˆ`threading / time / queue`ï¼‰ï¼Œè·¨å¹³å°å¯è¿è¡Œ

---

## å¿«é€Ÿå¼€å§‹

> å‡è®¾ä½ æŠŠç¤ºä¾‹ä¿å­˜ä¸º `priority_interrupt_cpu.py`ï¼ˆåŒ…å« `if __name__ == "__main__":` çš„æ¼”ç¤ºä»£ç ï¼‰

```bash
# 1) å…‹éš†ä»“åº“
git clone https://github.com/<your-name>/<your-repo>.git
cd <your-repo>

# 2) è¿è¡Œç¤ºä¾‹ï¼ˆçº¯æ ‡å‡†åº“ï¼Œæ— éœ€å®‰è£…ä¾èµ–ï¼‰
python3 priority_interrupt_cpu.py
```

è¿è¡Œåä½ ä¼šçœ‹åˆ°ï¼š
- ä¸»ç¨‹åºè‡ªå¢å¯„å­˜å™¨ A å¹¶å¾ªç¯
- åå°çº¿ç¨‹ä¾æ¬¡è§¦å‘ **ä½ä¼˜å…ˆçº§ â†’ é«˜ä¼˜å…ˆçº§ â†’ æœ€é«˜ä¼˜å…ˆçº§** çš„ä¸­æ–­
- CPU ä¼šæŒ‰ä¼˜å…ˆçº§æ‰“æ–­ä¸åµŒå¥—æ‰§è¡Œ ISR
- æœ€ç»ˆæ‰“å°å¯„å­˜å™¨ä¸å†…å­˜æ˜ å°„åŒºï¼ˆ0xF0â€“0xF3ï¼‰çš„ç»“æœ

---

## æ ¸å¿ƒè®¾è®¡

- **å–æŒ‡/æ‰§è¡Œå¾ªç¯**ï¼š`execute()` å†…éƒ¨è½®è¯¢ä¸­æ–­ â†’ å– opcode â†’ åˆ†å‘åˆ° `instructions` è¡¨ä¸­å¯¹åº”çš„æˆå‘˜æ–¹æ³•  
- **æŒ‡ä»¤å®ç°**ï¼šä»¥æ–¹æ³•å®ç°ï¼Œæ¯æ¡æŒ‡ä»¤è¿”å› `True/False` æ§åˆ¶ç»§ç»­/åœæ­¢ï¼›`update_flags()` æ›´æ–° Z/S/C ç­‰æ ‡å¿—  
- **ä¸­æ–­æ£€æŸ¥**ï¼š`check_interrupt()` ä»ä¼˜å…ˆé˜Ÿåˆ—é€‰æ‹©**å½“å‰å¤„ç†ä¸­æ–­ä¹‹ä¸Š**çš„æœ€é«˜ä¼˜å…ˆçº§ä¸­æ–­  
- **ä¸­æ–­å¤„ç†**ï¼š`handle_interrupt()` å°† `PC/FLAGS/å½“å‰ä¼˜å…ˆçº§` å‹æ ˆã€è·³è½¬åˆ°å‘é‡è¡¨æŒ‡å®šçš„ ISRï¼›`iret()` ä¾åºæ¢å¤

---

## å†…å­˜ä¸å¯„å­˜å™¨

- **å†…å­˜**ï¼š256 å­—èŠ‚ï¼ˆ`self.memory`ï¼‰
  - `0x00â€“0x07`ï¼šä¸­æ–­å‘é‡è¡¨ï¼ˆæ¯ä¸ªå‘é‡ 2 å­—èŠ‚ï¼šä½ä½åœ¨å‰ï¼Œé«˜ä½åœ¨åï¼‰
  - `0x20/0x30/0x40/0x50`ï¼šå†…ç½® ISR èµ·å§‹åœ°å€
  - `0x60`ï¼šç¤ºä¾‹ä¸»ç¨‹åºè£…è½½åœ°å€
  - `0xF0â€“0xF3`ï¼šç¤ºä¾‹ä¸­ä½œä¸ºâ€œå†…å­˜æ˜ å°„å¯„å­˜å™¨/çŠ¶æ€åŒºâ€
- **æ ˆ**ï¼š16 å­—èŠ‚ï¼ˆ`self.stack`ï¼‰ï¼Œ`SP` æŒ‡å‘**ä¸‹ä¸€ä¸ªå¯å†™å…¥ä½ç½®**ï¼ˆä» 0 é€’å¢ï¼‰
- **å¯„å­˜å™¨**ï¼š
  - é€šç”¨ï¼š`A, B, C, D`ï¼ˆ8 ä½ï¼‰
  - æµæ§ï¼š`PC`ï¼ˆ16 ä½ï¼Œä½†å†…å­˜ 8 ä½å¯»å€ï¼Œç¤ºä¾‹ä»…ç”¨ä½ 8 ä½ï¼‰ï¼Œ`SP`ï¼ˆ0â€“16ï¼‰
  - æ ‡å¿—ï¼š`FLAGS`  
    - `0x01`ï¼šCï¼ˆè¿›ä½/å€Ÿä½ï¼‰  
    - `0x02`ï¼šZï¼ˆé›¶ï¼‰  
    - `0x04`ï¼šSï¼ˆç¬¦å·/è´Ÿå·ï¼‰  
    - `0x08`ï¼šIï¼ˆä¸­æ–­å…è®¸ï¼‰

---

## ä¸­æ–­ç³»ç»Ÿ

- **ä¼˜å…ˆçº§**ï¼š`0`ï¼ˆæœ€é«˜ï¼‰â†’ `7`ï¼ˆæœ€ä½ï¼‰ã€‚ç¤ºä¾‹æ˜ å°„ï¼š
  - å‘é‡ 0 â†’ ä¼˜å…ˆçº§ 0ï¼ˆå¤ä½/æœ€é«˜ï¼‰
  - å‘é‡ 1 â†’ ä¼˜å…ˆçº§ 2ï¼ˆç¡¬æ•…éšœ/é«˜ï¼‰
  - å‘é‡ 2 â†’ ä¼˜å…ˆçº§ 4ï¼ˆå®šæ—¶å™¨/ä¸­ï¼‰
  - å‘é‡ 3 â†’ ä¼˜å…ˆçº§ 6ï¼ˆI/O/ä½ï¼‰
- **å±è”½**ï¼š`interrupt_mask`ï¼ˆ8 ä½ä½å›¾ï¼Œ1=å…è®¸ï¼Œ0=å±è”½ï¼‰ï¼Œä»¥åŠå…¨å±€ `interrupt_enabled`
- **åµŒå¥—**ï¼šè¿›å…¥ ISR æ—¶ä¿å­˜â€œå½“å‰ä¼˜å…ˆçº§â€ï¼Œä»…å…è®¸**æ›´é«˜**ä¼˜å…ˆçº§ä¸­æ–­å†æ‰“æ–­ï¼ˆ`nesting_level` è®¡æ•°ï¼‰
- **ä¿å­˜ç°åœº**ï¼ˆè¿›å…¥ ISRï¼‰ï¼š
  1. `PC low â†’ PC high â†’ FLAGS â†’ current_priority` ä¾æ¬¡å‹æ ˆ
  2. è®¾ä¸ºæ–°çš„ `current_priority`ï¼Œè·³è½¬åˆ°å‘é‡è¡¨æŒ‡å®šåœ°å€
- **æ¢å¤**ï¼ˆ`IRET`ï¼‰ï¼š
  1. ä¾æ¬¡å¼¹å‡º `saved_priority â†’ FLAGS â†’ PC high â†’ PC low`
  2. æ¢å¤ `PC / FLAGS / current_priority / interrupt_enabled`

---

## æŒ‡ä»¤é›†

> **æ“ä½œç  (Hex)**  â†’ **åŠ©è®°ç¬¦**  â†’ **è¯´æ˜**

### åŸºæœ¬
- `00` HLT åœæœº  
- `01` LDA #imm  
- `02` LDB #imm  
- `03` LDC #imm  
- `04` LDD #imm  
- `05` STA addr  
- `06` STB addr  
- `07` STC addr  
- `08` STD addr  
- `09` ADDï¼ˆA=A+Bï¼Œè®¾ C/Z/Sï¼‰  
- `0A` SUBï¼ˆA=Aâˆ’Bï¼Œå€Ÿä½è®¾ Cï¼‰  
- `0B` MULï¼ˆä½ 8 ä½ä¿ç•™ï¼Œæº¢å‡ºè®¾ Cï¼‰  
- `0C` DIVï¼ˆæ•´é™¤ï¼ŒB=0 æŠ¥é”™åœæœºï¼‰  
- `0D` INC A  
- `0E` DEC A  
- `0F` JMP addr  
- `10` JZ addr  
- `11` JNZ addr  
- `12` JC addr  
- `13` JNC addr  
- `14` JS addr  
- `15` JNS addr  
- `16` OUTï¼ˆæ‰“å° Aï¼‰  
- `17` NOP

### é€»è¾‘
- `18` ANDï¼ˆA=A&Bï¼‰  
- `19` ORï¼ˆA=A|Bï¼‰  
- `1A` XORï¼ˆA=A^Bï¼‰  
- `1B` NOTï¼ˆA=~Aï¼‰

### ä½ç§»/å¾ªç¯ç§»ä½ï¼ˆC å‚ä¸/è®°å½•ï¼‰
- `1C` SHLï¼ˆæœ€é«˜ä½â†’Cï¼‰  
- `1D` SHRï¼ˆæœ€ä½ä½â†’Cï¼‰  
- `1E` ROLï¼ˆ(A<<1)|Cï¼‰  
- `1F` RORï¼ˆ(A>>1)|C<<7ï¼‰

### æ ˆä¸è°ƒç”¨
- `20` PUSH Aï¼ˆæˆ– `push(value)` å†…éƒ¨ä½¿ç”¨ï¼‰  
- `21` POP â†’ A  
- `22` CALL addrï¼ˆå‹è¿”å›åœ°å€åè·³è½¬ï¼›ç¤ºä¾‹æŒ‰â€œå•å­—èŠ‚åœ°å€â€ï¼‰  
- `23` RETï¼ˆå¼¹å› PCï¼‰

### æ•°æ®ä¼ é€
- `24` MOV A,B  
- `25` MOV A,C  
- `26` MOV A,D  
- `27` MOV B,A  
- `28` MOV B,C  
- `29` MOV B,D  
- `2A` MOV C,A  
- `2B` MOV C,B  
- `2C` MOV C,D  
- `2D` MOV D,A  
- `2E` MOV D,B  
- `2F` MOV D,C

### æ¯”è¾ƒ/è¾“å…¥
- `30` CMPï¼ˆA ä¸ Bï¼Œè®¾ C/Z/Sï¼‰  
- `31` INï¼ˆä» `input()` è¯»å…¥åˆ° Aï¼Œæ© 0xFFï¼‰

### ä¸­æ–­æ§åˆ¶
- `32` EIï¼ˆå…è®¸ä¸­æ–­ï¼Œç½® I æ ‡å¿—ï¼‰  
- `33` DIï¼ˆç¦æ­¢ä¸­æ–­ï¼Œæ¸… I æ ‡å¿—ï¼‰  
- `34` IRETï¼ˆä¸­æ–­è¿”å›ï¼Œæ¢å¤ç°åœºï¼‰  
- `35` INT #vecï¼ˆè½¯ä»¶è§¦å‘å‘é‡ï¼‰

---

## ç¤ºä¾‹ç¨‹åº

æ¼”ç¤ºä¸»ç¨‹åºï¼ˆåŠ è½½åˆ° `0x60`ï¼‰ï¼š
```python
main_program = [
    0x32,        # EI
    0x01, 0x00,  # LDA #00
    0x0D,        # INC
    0x07, 0x02,  # JMP 0x02ï¼ˆå¾ªç¯ï¼‰
]
```

æ¼”ç¤ºä¸­æ–­çº¿ç¨‹ï¼š
```python
# ä¾æ¬¡è§¦å‘ï¼šä½ä¼˜å…ˆçº§(I/O, vec=3) â†’ é«˜ä¼˜å…ˆçº§(ç¡¬æ•…éšœ, vec=1) â†’ æœ€é«˜ä¼˜å…ˆçº§(å¤ä½, vec=0)
# è§‚å¯ŸåµŒå¥—æ‰“æ–­ä¸ IRET æ¢å¤
```

å†…ç½® ISRï¼ˆç”± `setup_interrupt_handlers()` å†™å…¥å†…å­˜ï¼‰ï¼š
- **å‘é‡ 0ï¼ˆ0x20ï¼‰**ï¼š`LDA #0xFF; STA 0xF0; IRET`ï¼ˆç³»ç»ŸçŠ¶æ€ï¼‰
- **å‘é‡ 1ï¼ˆ0x30ï¼‰**ï¼š`LDA #0xEE; STA 0xF1; IRET`ï¼ˆé”™è¯¯ç ï¼‰
- **å‘é‡ 2ï¼ˆ0x40ï¼‰**ï¼š`STA 0xF2; INC; IRET`ï¼ˆå®šæ—¶å™¨è®¡æ•°ï¼‰
- **å‘é‡ 3ï¼ˆ0x50ï¼‰**ï¼š`IN; STA 0xF3; IRET`ï¼ˆI/O è¾“å…¥ï¼‰

è¿è¡Œæˆªå›¾ï¼ˆç¤ºæ„è¾“å‡ºï¼‰ï¼š
```
å¼€å§‹æ‰§è¡Œç¨‹åº...
ä¸­æ–­è¯·æ±‚: å‘é‡ 3, ä¼˜å…ˆçº§ 6
å¤„ç†ä¸­æ–­ 3 (ä¼˜å…ˆçº§: 6), å½“å‰ä¼˜å…ˆçº§: -1
è·³è½¬åˆ°ä¸­æ–­å¤„ç†ç¨‹åº 0x0050, åµŒå¥—å±‚çº§: 1
...
è§¦å‘é«˜ä¼˜å…ˆçº§ä¸­æ–­ (ç¡¬ä»¶æ•…éšœ)...
å¤„ç†ä¸­æ–­ 1 (ä¼˜å…ˆçº§: 2), å½“å‰ä¼˜å…ˆçº§: 6
è·³è½¬åˆ°ä¸­æ–­å¤„ç†ç¨‹åº 0x0030, åµŒå¥—å±‚çº§: 2
...
è§¦å‘æœ€é«˜ä¼˜å…ˆçº§ä¸­æ–­ (ç³»ç»Ÿå¤ä½)...
å¤„ç†ä¸­æ–­ 0 (ä¼˜å…ˆçº§: 0), å½“å‰ä¼˜å…ˆçº§: 2
è·³è½¬åˆ°ä¸­æ–­å¤„ç†ç¨‹åº 0x0020, åµŒå¥—å±‚çº§: 3
...
æœ€ç»ˆå¯„å­˜å™¨çŠ¶æ€:
A: 0x?? (...)
...
åœ°å€ 0xF0: 255 (ç³»ç»ŸçŠ¶æ€)
åœ°å€ 0xF1: 238 (é”™è¯¯ä»£ç )
åœ°å€ 0xF2: N   (å®šæ—¶å™¨å€¼)
åœ°å€ 0xF3: M   (è¾“å…¥æ•°æ®)
```

---

## æ‰©å±•ä¸å¼€å‘

- **æ–°å¢æŒ‡ä»¤**  
  1. ä¸ºæŒ‡ä»¤åˆ†é…æ“ä½œç ï¼ˆæœªå ç”¨ï¼‰  
  2. åœ¨ `instructions` æ˜ å°„ä¸­æ³¨å†Œï¼š`self.instructions[0xXX] = self.your_impl`  
  3. å®ç°åœ¨ç±»ä¸­æ·»åŠ æ–¹æ³•ï¼Œå¹¶åœ¨éœ€è¦æ—¶è°ƒç”¨ `update_flags()`  

- **å¢åŠ ä¸­æ–­**  
  - æ‰©å±• `interrupt_priorities` ä¸å‘é‡è¡¨ï¼ˆ`memory[0x00..]`ï¼‰ï¼Œåœ¨ `setup_interrupt_handlers()` å†™å…¥æ–°çš„ ISR  
  - ä¿®æ”¹ `trigger_interrupt()` ä»¥æ”¯æŒæ›´å¤šå‘é‡ï¼ˆç¤ºä¾‹å½“å‰æ ¡éªŒ `0..3`ï¼‰

- **å†…å­˜æ˜ å°„ I/O**  
  - çº¦å®šåœ°å€åŒºé—´ï¼ˆå¦‚ 0xF0â€“0xFFï¼‰ï¼Œåœ¨ `sta/stb/...` æ—¶è§¦å‘å¤–è®¾å›è°ƒ

- **æµ‹è¯•**  
  - å°† `execute(max_cycles=...)` è®¾å°ä»¥ä¾¿å¯æ§  
  - ä¸ºæ¯æ¡æŒ‡ä»¤å†™æœ€å°ç”¨ä¾‹ï¼šå‡†å¤‡å¯„å­˜å™¨ â†’ æ‰§è¡ŒæŒ‡ä»¤ â†’ æ–­è¨€å¯„å­˜å™¨/æ ‡å¿—/å†…å­˜ç»“æœ

---

## å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆ `IRET` çš„å¼¹æ ˆé¡ºåºçœ‹èµ·æ¥æœ‰ç‚¹â€œåç›´è§‰â€ï¼Ÿ**  
A: å…¥æ ˆé¡ºåºæ˜¯ `PC low â†’ PC high â†’ FLAGS â†’ current_priority`ï¼Œå‡ºæ ˆå¿…é¡»**é€†åº**ï¼Œå…ˆä¼˜å…ˆçº§ã€å† FLAGSã€å† PC é«˜/ä½ä½ï¼Œä¿è¯çŠ¶æ€ä¸€è‡´æ€§ã€‚

**Q: ä¸ºä»€ä¹ˆ `PC` åªæœ‰ 8 ä½å¯»å€ï¼Ÿ**  
A: æ¼”ç¤ºä¸­ `PC` ä»¥ 16 ä½ä¿å­˜/å‹æ ˆï¼Œä½†å†…å­˜æ˜¯ 8 ä½å¯»å€ï¼ˆ256 å­—èŠ‚ï¼‰ã€‚ä¿ç•™é«˜ä½æ˜¯ä¸ºäº†å±•ç¤ºä¿å­˜ç°åœºä¸æ‰©å±•ç©ºé—´ï¼Œç®€åŒ–å®ç°ã€‚

**Q: é™¤æ³•å¯¹ 0 æ€ä¹ˆåŠï¼Ÿ**  
A: `DIV`ï¼ˆ0x0Cï¼‰åœ¨ `B==0` æ—¶æ‰“å°é”™è¯¯å¹¶**åœæ­¢æ‰§è¡Œ**ï¼ˆè¿”å› `False`ï¼‰ã€‚

---

## Roadmap

- [ ] å¯é€‰**æ—¶é’Ÿæ­¥è¿›**ä¸å•æ­¥è°ƒè¯•ï¼ˆæ–­ç‚¹ã€è¿½è¸ªæŒ‡ä»¤æµï¼‰  
- [ ] æ±‡ç¼–å™¨/åŠ è½½å™¨ï¼ˆæŠŠåŠ©è®°ç¬¦ç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼‰  
- [ ] æ›´å®Œæ•´çš„**å†…å­˜æ˜ å°„ I/O** ç¤ºä¾‹ï¼ˆå¦‚ UART/Timerï¼‰  
- [ ] æ‰©å±•åˆ° 16 ä½å¯»å€ä¸åˆ†é¡µ  
- [ ] æŒ‡ä»¤è¦†ç›–ç‡å•æµ‹

---

## è®¸å¯è¯

å»ºè®®ä½¿ç”¨ MITï¼šåœ¨ä»“åº“æ ¹ç›®å½•æ·»åŠ  `LICENSE` æ–‡ä»¶ã€‚

---

## è´¡çŒ®

æ¬¢è¿ PR / Issueï¼  
- æäº¤å‰è¯·å°½é‡é™„å¸¦æœ€å°å¤ç°ä¸æœŸæœ›è¡Œä¸º  
- å¯¹æ–°å¢æŒ‡ä»¤è¯·è¡¥å…… README ä¸ç¤ºä¾‹

---

## è‡´è°¢

æœ¬é¡¹ç›®ç”¨äºæ•™å­¦ä¸ç»ƒä¹ ç›®çš„ï¼Œæ„Ÿè°¢æ‰€æœ‰åé¦ˆæ”¹è¿›å»ºè®®çš„åŒå­¦ ğŸ™Œ

---

### ä»“åº“ç»“æ„ï¼ˆå»ºè®®ï¼‰

```
.
â”œâ”€â”€ priority_interrupt_cpu.py   # æ ¸å¿ƒ & ç¤ºä¾‹main
â”œâ”€â”€ README.md                   # æœ¬æ–‡ä»¶
â”œâ”€â”€ LICENSE                     # è®¸å¯è¯ï¼ˆå»ºè®®MITï¼‰
â””â”€â”€ tests/                      # å¯é€‰ï¼šå•å…ƒæµ‹è¯•
```
